---
title: "VoC Main Analyses"
date: 6/5/23
output:
    html_document:
        df_print: 'paged'
        toc: true
        toc_float:
            collapsed: false
            smooth_scroll: true
        number_sections: false
        code_download: true
        self_contained: true
---
```{r chunk settings, include = FALSE}

# set chunk settings
knitr::opts_chunk$set(echo = FALSE, 
                      cache = TRUE,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_chunk$set(dpi=600)
```
                      
```{r setup, include=FALSE}

# list all packages required for the analysis
list.of.packages <- c("tidyverse", "afex")

# check if all packages are installed, if not, install them.
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# load all packages 
lapply(list.of.packages, library, character.only = TRUE)

# add theme for plotting
perri_theme <- function () {
  theme(
    panel.border = element_rect(fill = "transparent", color="gray75"),
    panel.background  = element_blank(),
    plot.background = element_blank(), 
    legend.background = element_rect(fill="transparent", colour=NA),
    legend.key = element_rect(fill="transparent", colour=NA),
    line = element_blank(),
    axis.ticks = element_line(color="gray75"),
    text=element_text(family="Avenir"),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 15),
    title = element_text(size = 15),
    strip.background = element_blank(),
    strip.text = element_text(size=12)
  )
}

color1 = "#00b4d8"
color2 = "#0077b6"
color3 = "#03045e"

# load data
load("data/vocDataTidy.RData")
```

# Participant demographics
```{r participants plot}
# plot histogram of male and female participants
banditTask %>% mutate(wholeAge = floor(age)) %>% 
    group_by(subID, gender,wholeAge) %>% 
    distinct(subID) %>% 
  ggplot(., aes(x=wholeAge, fill=gender)) +
  geom_histogram(binwidth = 1, color="white") +
  scale_fill_manual(name="Sex",
                    labels=c("Female", "Male"),
                    values=c("#e08283", "#00b5cc")) +
  scale_y_continuous(breaks = c(2,4,6,8,10),
                   labels = c("2","4","6","8","10"),
                   limits = c(0,10)) +
  perri_theme() +
  xlab("Age") +
  ylab("Count")
```


# Agency task: Machine selection stage
## Model: Optimal machine choices by condition, trial, and age
```{r machine choices across trials by age}

# Filter data to have only trials where people choose agency and exclude trials with 50-50 condition 
banditTask.filtered <- banditTask %>% 
    filter(agency==1, condition!="bandits5050")

# Scale continuous variables
banditTask.filtered$zAge <- scale(banditTask.filtered$age)
banditTask.filtered$zTrialOfCond <- scale(banditTask.filtered$trialOfCond)

# Mixed-effects logistic regression model
correct_byConditionTrialAge.mixed <- mixed(correct ~ condition*zTrialOfCond*(zAge) + (condition*zTrialOfCond|subID), 
                data = banditTask.filtered,
                family = binomial, 
                method = "LRT",
                control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=1e6)))

#display model stats
correct_byConditionTrialAge.mixed 
```

## Plot: Proportion optimal machine selections across age groups and trials
```{r plot bandit choices across trials, width = 7, height = 4, unit = "in"}
banditTask %>% 
  filter(agency==1, condition!="bandits5050") %>% 
  group_by(condition, block, ageGrp) %>% 
  summarize(pctCorr = mean(correct), 
    se = sd(correct)/sqrt(n())) %>% 
  ggplot(., aes(x=block, y=pctCorr, color=condition)) +
  geom_point() +
    geom_smooth(method = "lm", aes(fill = condition)) +
  geom_hline(yintercept = .5, linetype="dashed") +
  perri_theme() +
  ylab("Proportion Optimal Machine Selections") +
    xlab("Block") +
  facet_wrap(~ageGrp) +
      scale_fill_manual(name="Condition",
                      labels=c("70/30",
                               "90/10"),
                      values=c("#0077b6", "#03045e"), 
                      guide = guide_legend(reverse=TRUE)) +
  scale_color_manual(name="Condition",
                      labels=c("70/30",
                               "90/10"),
                      values=c("#0077b6", "#03045e"),
                     guide = guide_legend(reverse=TRUE)) +
  theme(strip.text = element_text(size=12))
```


# Agency task: Agency decisions 
## Model: Agency decisions by condition, trial, and age
```{r agency decisions by condition}

# predict agency choice from condition, trial, and age
agency_byConditionTrialAge.mixed = mixed(agency ~ condition * zTrialOfCond * zAge + (condition * zTrialOfCond || subID), 
                        data = banditTask, 
                        family = binomial, 
                        method = "LRT",
                        expand_re = T, control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=1e6))) 

#display stats
agency_byConditionTrialAge.mixed
```


## Mode: Agency decisions by VoC, trial, and age
```{r voc model}
#scale uoc
banditTask$zVoC<- scale(banditTask$uoc)

# predict agency choice from VoC, trial, and age
agency_byVOCTrialAge.mixed = mixed(agency ~ zVoC * zTrialOfCond * zAge + (zVoC * zTrialOfCond|subID), 
                        data = banditTask, 
                        family = binomial, 
                        method = "LRT", control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=1e6))) 

#display stats
agency_byVOCTrialAge.mixed
```

## Plot: Agency choices by condition
```{r plot agency decisions, fig.height = 4, fig.width = 7, unit = "in"}

# all conditions
ggplot(data=(banditTask %>% 
               group_by(condition, block, ageGrp) %>%
             summarize(m=mean(agency),se=sd(agency)/sqrt(n()))),
       aes(x=block, y=m, group=condition, color=condition)) +
  geom_point() +
    geom_smooth(method = "lm", aes(fill = condition)) +
  facet_wrap(~ageGrp) +
  ylim(.4,.8) +
  perri_theme() +
  ylab("Proportion Agency Choices") +
    xlab("Block") +
  scale_fill_manual(name="Condition",
                      labels=c("50/50", 
                               "70/30", 
                               "90/10"),
                      values=c("#00b4d8", "#0077b6", "#03045e"), 
                      guide = guide_legend(reverse=TRUE)) +
  scale_color_manual(name="Condition",
                      labels=c("50/50", 
                               "70/30", 
                               "90/10"),
                      values=c("#00b4d8", "#0077b6", "#03045e"),
                      guide = guide_legend(reverse=TRUE))

```


## Plot: Agency choices by VoC
```{r VoC plot, fig.height = 4, fig.width = 7, unit = "in"}

VoC_plot_sub_means <- banditTask %>% 
    mutate(taskHalf = case_when(trial < 158 ~ "First Half of Task",
                                trial > 157 ~ "Second Half of Task")) %>%
    group_by(ageGrp, taskHalf, uoc, subID) %>%
    summarize(meanSubAgency = mean(agency, na.rm = T))

VoC_plot_means <- VoC_plot_sub_means %>% 
    group_by(ageGrp, taskHalf, uoc) %>%
    summarize(meanAgency = mean(meanSubAgency, na.rm = T),
              seAgency = sd(meanSubAgency / sqrt(n())))

#plot
VoC_plot <- ggplot(VoC_plot_means, aes(x = uoc, y = meanAgency, color = ageGrp)) +
    facet_wrap(~taskHalf) +
    geom_point(aes(color = ageGrp)) + 
    geom_errorbar(aes(color = ageGrp, ymin = meanAgency - seAgency, ymax = meanAgency + seAgency), width = .1) + 
    geom_line(aes(group = ageGrp)) +
    perri_theme() + 
    scale_color_manual(values=c("#84347C", "#B40424", "#EB6D1E"), name = "Age Group") +
    xlab("Value of Control (VoC)") +
    ylab("Proportion Agency Choices") +
    geom_hline(yintercept = .5, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed")
VoC_plot

```

## Summary stats: Proportion of trials agency chosen when VoC = 0
```{r VoC summary stats}

# What proportion of trials did they choose agency when VoC was 0?
VoC_zero_means_sub <- banditTask %>% 
    filter(uoc == 0) %>%
    group_by(subID) %>%
    summarize(meanSubAgency = mean(agency, na.rm = T))

VoC_zero_means <- VoC_zero_means_sub %>%
    summarize(meanAgency = mean(meanSubAgency, na.rm = T),
              seAgency = sd(meanSubAgency / sqrt(n())))
VoC_zero_means
```


# Choice preference task 
## Choice preference task: Summary stats
```{r reward sense summary stats}
# summary stats for accuracy
overallAcc <- rewardSense %>% 
    group_by(subID) %>% 
    filter(accuracy!=0) %>% 
    summarize(m=mean(correct, na.rm=T)) %>% 
    ungroup() %>% 
    summarize(meanAccuracy = mean(m), stdev = sd(m))
overallAcc

# mean = 76.9%
# stdev = 15.3%
```

## Model: Choice preference task accuracy
```{r bandit choices across by age in post-task assessment}

# first, filter data and rescale variables
rewardSense.filtered <- rewardSense %>%  filter(accuracy!=0)

# rescale variables of age and the true probability differences between two displayed bandits 
rewardSense.filtered$zAge <- scale(rewardSense.filtered$age)
rewardSense.filtered$zDiff<- scale(rewardSense.filtered$diff)

# run model
rewardSense.mixed <- mixed(correct~zDiff*zAge + (zDiff|subID), 
                           data= rewardSense.filtered,
                           family = binomial,
                           method = "LRT")
rewardSense.mixed 
```



# Explicit reward knowledge task 
## Explicit reward knowledge task: Summary stats
```{r}
# summary stats for error
# mean = 1.43
# stdev = .872

explicitKnow %>% 
  group_by(subID, age) %>% 
  summarize(m = mean(error)) %>% 
  ungroup() %>% 
  summarize(meanErr = mean(m, na.rm=T), sd = sd(m,na.rm = T))
```

## Model: Explicit reward knowledge by age and true probabilities
```{r explicit knowledge model}
# predict trial-level error from true probability and age

#re-scale age and zTrueProb
explicitKnow.filtered <- explicitKnow %>%
    select(subID, age, trueProb, response, error) %>%
    drop_na()

explicitKnow.filtered$zAge <- scale(explicitKnow.filtered$age)
explicitKnow.filtered$zTrueProb <- scale(explicitKnow.filtered$trueProb)

# run model
explicitKnow_errorbyTrueProbAge.mixed <- mixed(error ~ zTrueProb*zAge + (1|subID), 
                                               data = explicitKnow.filtered,
                                               method = "S") 
explicitKnow_errorbyTrueProbAge.mixed
```

## Plot: Explicit reward knowledge
```{r plot explicit knowledge}
# plot response by bandit
explicitKnow %>% 
    ggplot(., aes(x=bandit,y=response, fill=ageGrp)) +
    geom_boxplot() +
    scale_fill_manual(values = c(color1, color2, color3), name = "Age Group") +
    ylab("Reported Reward Probability") +
    xlab("True Reward Probability") +
    scale_x_discrete(labels = c("10%", "30%", "50%", "50%", "70%", "90%")) +
    scale_y_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9), 
                     labels = c("10%", "20%", "30%", "40%", "50%", "60%", "70%", "80%", "90%")) +
    perri_theme()
```
